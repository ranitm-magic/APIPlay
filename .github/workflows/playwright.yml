name: Playwright Tests

on:
  repository_dispatch:
    types: [web_app_push]
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Will RUN ALL THE TESTS IN THIS '
        required: false
        type: string

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: |
          if [ "${{ steps.cache-playwright.outputs.cache-hit }}" = "true" ]; then
            echo "Browsers found in cache, verifying installation..."
            npx playwright install --dry-run > /dev/null 2>&1 || npx playwright install chromium
          else
            echo "Installing Playwright browsers and dependencies..."
            npx playwright install --with-deps chromium
          fi

      - name: Run Playwright tests
        id: playwright-tests
        continue-on-error: true
        run: |
          set +e
          if [ -n "${{ github.event.inputs.test_pattern }}" ]; then
            npx playwright test "${{ github.event.inputs.test_pattern }}"
          else
            npx playwright test
          fi
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit 0

      - name: Parse test results
        id: test-summary
        run: |
          if [ -f "test-results.json" ]; then
            echo "=== ANALYZING test-results.json ==="
            
            passed=$(jq -r '.stats.expected // 0' test-results.json)
            failed=$(jq -r '.stats.unexpected // 0' test-results.json)
            skipped=$(jq -r '.stats.skipped // 0' test-results.json)
            flaky=$(jq -r '.stats.flaky // 0' test-results.json)
            duration=$(jq -r '(.stats.duration // 0) / 1000' test-results.json)

            echo "Final counts: passed=$passed, failed=$failed, skipped=$skipped, flaky=$flaky, duration=${duration}s"
            echo "passed=${passed}" >> $GITHUB_OUTPUT
            echo "failed=${failed}" >> $GITHUB_OUTPUT
            echo "skipped=${skipped}" >> $GITHUB_OUTPUT
            echo "flaky=${flaky}" >> $GITHUB_OUTPUT
            echo "duration=${duration}" >> $GITHUB_OUTPUT
            echo "results_available=true" >> $GITHUB_OUTPUT
          else
            echo "test-results.json not found, setting default values"
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            echo "flaky=0" >> $GITHUB_OUTPUT
            echo "duration=0" >> $GITHUB_OUTPUT
            echo "results_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Playwright Report
        id: upload-report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results.json
          retention-days: 10

      - name: Set status color
        id: status-color
        run: |
          if [ "${{ steps.test-summary.outputs.failed }}" -gt 0 ]; then
            echo "status_color=#e74c3c" >> $GITHUB_OUTPUT
            echo "status_text=failed" >> $GITHUB_OUTPUT
          else
            echo "status_color=#28a745" >> $GITHUB_OUTPUT
            echo "status_text=success" >> $GITHUB_OUTPUT
          fi

      - name: Generate email content
        if: always()
        id: generate-email
        run: |
          echo '${{ toJSON(github.event.client_payload) }}' > client_payload.json
          
          sha=$(jq -r '.sha // "N/A"' client_payload.json)
          commit_author=$(jq -r '.commit_author // "N/A"' client_payload.json)
          commit_id=$(jq -r '.commit_id // "N/A"' client_payload.json)
          repository=$(jq -r '.repository // "N/A"' client_payload.json)
          ref=$(jq -r '.ref // "N/A"' client_payload.json)
          
          # Generate the artifact download URL
          artifact_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ steps.upload-report.outputs.artifact-id }}"

          cat > email_body.html << EOF
          <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <h2 style="color:#2E86C1;">🎭 Playwright Test Results</h2>
              <p><strong>Status:</strong> 
                <span style="color:${{ steps.status-color.outputs.status_color }};">
                  ${{ steps.status-color.outputs.status_text }}
                </span>
              </p>

              <h3>Test Summary</h3>
              <table border="1" cellspacing="0" cellpadding="8" style="border-collapse: collapse; width: 70%; max-width: 500px; text-align:center;">
                <tr style="background:#f2f2f2;">
                  <th>Passed ✅</th>
                  <th>Failed ❌</th>
                  <th>Skipped ⚡</th>
                  <th>Flaky 🔁</th>
                  <th>Duration ⏱</th>
                </tr>
                <tr>
                  <td style="color:#28a745;">${{ steps.test-summary.outputs.passed }}</td>
                  <td style="color:#e74c3c;">${{ steps.test-summary.outputs.failed }}</td>
                  <td style="color:#f39c12;">${{ steps.test-summary.outputs.skipped }}</td>
                  <td style="color:#8e44ad;">${{ steps.test-summary.outputs.flaky }}</td>
                  <td>${{ steps.test-summary.outputs.duration }}s</td>
                </tr>
              </table>
              
              <h3 style="margin-top:20px;">📌 Metadata</h3>
              <table border="1" cellspacing="0" cellpadding="8" style="border-collapse: collapse; width: 100%; max-width: 600px;">
                <tr>
                  <td><strong>Repository</strong></td>
                  <td>${{ github.repository }}</td>
                </tr>
                <tr>
                  <td><strong>Triggered by</strong></td>
                  <td>${{ github.event_name }}</td>
                </tr>
          EOF
          
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            cat >> email_body.html << EOF
                <tr>
                  <td><strong>Web App Commit</strong></td>
                  <td><code>$sha</code></td>
                </tr>
                <tr>
                  <td><strong>Author</strong></td>
                  <td>$commit_author</td>
                </tr>
                <tr>
                  <td><strong>Commit ID</strong></td>
                  <td><code>$commit_id</code></td>
                </tr>
                <tr>
                  <td><strong>Web App Repository</strong></td>
                  <td>$repository</td>
                </tr>
                <tr>
                  <td><strong>Branch</strong></td>
                  <td>$ref</td>
                </tr>
          EOF
          fi
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.test_pattern }}" ]; then
            cat >> email_body.html << EOF
                <tr>
                  <td><strong>Test Pattern</strong></td>
                  <td><code>${{ github.event.inputs.test_pattern }}</code></td>
                </tr>
          EOF
          fi
          
          cat >> email_body.html << EOF
                <tr>
                  <td><strong>Workflow Run</strong></td>
                  <td>${{ github.run_id }}</td>
                </tr>
              </table>

              <h3 style="margin-top:20px;">📊 Links & Reports</h3>
              <div style="margin-top:15px;">
                <p style="margin-bottom:10px;">
                  🔗 <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                        style="color:#2E86C1; text-decoration:none; font-weight:bold;">
                    View Workflow Logs
                  </a>
                </p>
                
                <p style="margin-bottom:10px;">
                  📄 <a href="$artifact_url"
                        style="color:#2E86C1; text-decoration:none; font-weight:bold;">
                    Download Playwright Report (Artifact ID: ${{ steps.upload-report.outputs.artifact-id }})
                  </a>
                </p>
              </div>

              <div style="text-align:center; margin-top:25px;">
                <a href="$artifact_url"
                   style="display:inline-block; padding:12px 25px; background:#2E86C1; color:#fff; 
                          text-decoration:none; border-radius:25px; font-weight:bold; font-size:14px;">
                  📥 Download Full Test Report
                </a>
              </div>

              <hr style="margin-top:30px; border:none; border-top:1px solid #ddd;" />
              <p style="font-size:12px; color:#999;">This is an automated email from GitHub Actions - Playwright CI.</p>
            </body>
          </html>
          EOF
          
          email_content=$(cat email_body.html)
          echo "email_content<<EOF" >> $GITHUB_OUTPUT
          echo "$email_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 🔥PLAYWRIGHT TEST RESULTS - ${{ steps.status-color.outputs.status_text }}
          html_body: ${{ steps.generate-email.outputs.email_content }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: Playwright Tests <${{ secrets.EMAIL_USERNAME }}>

      - name: Clean up old workflow runs
        if: always()
        run: |
          echo "🧹 Starting workflow cleanup..."
          
          # Set the maximum number of runs to keep
          MAX_RUNS=30
          
          # Get workflow runs for this workflow (sorted by created date, newest first)
          WORKFLOW_ID=$(gh api repos/${{ github.repository }}/actions/workflows \
            --jq '.workflows[] | select(.name == "Playwright Tests") | .id')
          
          echo "Found workflow ID: $WORKFLOW_ID"
          
          # Get all runs for this workflow
          RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs \
            --paginate --jq '.workflow_runs[].id' | head -100)
          
          # Convert to array and count
          RUNS_ARRAY=($RUNS)
          TOTAL_RUNS=${#RUNS_ARRAY[@]}
          
          echo "Total workflow runs found: $TOTAL_RUNS"
          echo "Maximum runs to keep: $MAX_RUNS"
          
          if [ $TOTAL_RUNS -gt $MAX_RUNS ]; then
            RUNS_TO_DELETE=$((TOTAL_RUNS - MAX_RUNS))
            echo "Will delete $RUNS_TO_DELETE old workflow runs..."
            
            # Delete old runs (skip first MAX_RUNS, delete the rest)
            for (( i=$MAX_RUNS; i<$TOTAL_RUNS; i++ )); do
              RUN_ID=${RUNS_ARRAY[$i]}
              echo "Deleting workflow run: $RUN_ID"
              
              # Delete the workflow run
              gh api repos/${{ github.repository }}/actions/runs/$RUN_ID \
                -X DELETE || echo "Failed to delete run $RUN_ID (might already be deleted or in progress)"
              
              # Small delay to avoid rate limiting
              sleep 1
            done
            
            echo "✅ Cleanup completed! Deleted $RUNS_TO_DELETE old workflow runs."
          else
            echo "✅ No cleanup needed. Current runs ($TOTAL_RUNS) are within limit ($MAX_RUNS)."
          fi
        env:
          GH_TOKEN: ${{ github.token }}